<?php
/**
 * @file
 */

/**
 * Human name.
 */
define('MOHA_MAILER', 'Moha Mailer');

/**
 * Machine name.
 */
define('__MOHA_MAILER', 'moha_mailer');

/**
 * Entity Machine name.
 */
define('__MOHA_MAILER_MAIL', 'moha_mailer_mail');

/**
 * Entity Human name.
 */
define('MOHA_MAILER_MAIL', 'Moha Mailer Mail');

/**
 * sites/all/modules/custom/moha/modules/moha_mailer.
 */
define('MOHA_MAILER__PATH', drupal_get_path('module', __MOHA_MAILER));

/**
 * /sites/all/modules/custom/moha/modules/moha_mailer.
 */
define('__MOHA_MAILER__PATH', base_path() . MOHA_MAILER__PATH);

/**
 * Module variables name: moha_mailer__var__manual_to.
 *
 * Reuse mail to data collected from manual sending to.
 */
define('MOHA_MAILER__VARIABLE__MANUAL_TO', __MOHA_MAILER. '__var__manual_to');

/**
 * Module variables name: moha_mailer__var__manual_from.
 *
 * Reuse mail from data collected from manual sending form.
 */
define('MOHA_MAILER__VARIABLE__MANUAL_FROM', __MOHA_MAILER. '__var__manual_from');

/**
 * Module variables name: moha_mailer__var__threshold.
 *
 * How many mail
 */
define('MOHA_MAILER__VARIABLE__THRESHOLD', __MOHA_MAILER. '__var__threshold');

/**
 * Module variables name: moha_mailer__var__suspend.
 *
 * TRUE to suspend mail sending.
 */
define('MOHA_MAILER__VARIABLE__SUSPEND', __MOHA_MAILER. '__var__suspend');

/**
 * Moha Mailer URL: Moha Mailer mail management page.
 */
define('MOHA_MAILER__URL__MAIL_ADMIN_UI', MOHA__URL__ENTITIES . '/mailer-mail');

/**
 * Implements hook_entity_info().
 */
function moha_mailer_entity_info() {

  $items[__MOHA_MAILER_MAIL] = moha_define_entity(
    __MOHA_MAILER,
    __MOHA_MAILER_MAIL,
    MOHA_MAILER_MAIL,
    'MohaMailerMail',
    MOHA_MAILER__URL__MAIL_ADMIN_UI
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function moha_mailer_permission() {
  // Declare entity permissions.
  $permissions = moha_entity_permission(__MOHA_MAILER_MAIL);

  return $permissions;
}

/**
 * Implements hook_menu().
 */
function moha_mailer_menu() {
  $items['admin/moha/mailer'] = array(
    'title' => 'Moha Mailer',
    'description' => t('Moha Mail enhancement system.'),
    'page callback' => 'system_admin_menu_block_page',
    'weight' => 10,
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/moha/mailer/dashboard'] = array(
    'title' => 'Moha mailer dashboard',
    'description' => t('Moha mail statistics / dashboard.'),
    'weight' => -99,
    'page callback' => 'drupal_get_form',
    /* @see moha_mailer_dashboard_form() */
    'page arguments' => array('moha_mailer_dashboard_form'),
    'file' => 'moha_mailer.admin.inc',
    'access arguments' => array(MOHA__PERMISSION__ROOT),
  );

  $items['admin/moha/mailer/config'] = array(
    'title' => 'Moha mailer configuration',
    'description' => t('Moha mailer configuration.'),
    'page callback' => 'drupal_get_form',
    /* @see moha_mailer_config_form() */
    'page arguments' => array('moha_mailer_config_form'),
    'file' => 'moha_mailer.admin.inc',
    'access arguments' => array(MOHA__PERMISSION__ROOT),
  );

  $items['admin/moha/mailer/manual'] = array(
    'title' => 'Moha mail manual sending',
    'description' => t('Manual mail sending function.'),
    'page callback' => 'drupal_get_form',
    /* @see moha_mailer_manual_form() */
    'page arguments' => array('moha_mailer_manual_form'),
    'file' => 'moha_mailer.admin.inc',
    'access arguments' => array(MOHA__PERMISSION__ROOT),
  );

  return $items;
}

/**
 * Implements hook_mail().
 *
 * @inheritdoc
 */
function moha_mailer_mail($key, &$message, $params) {
  if (substr($key, 0, 18) === 'moha_mailer_manual') {
    $message['subject'] = $params['subject'];
    $message['body'] = $params['body'];
  }
  else {
    mimemail_mail($key, $message, $params);
  }
}

/**
 * Sends queued mails through cron per entity moha_mailer_mail.
 *
 * Implements hook_cron().
 */
function moha_mailer_cron() {
  try {

    moha_throw_exception_per_variable(MOHA_MAILER__VARIABLE__SUSPEND);

    // Get queued mails, then send.
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', __MOHA_MAILER_MAIL);
    $query->propertyCondition('status', moha_array_key_by_value(MOHA__TERM__QUEUED, MOHA__STATUS__ENTITY));
    $query->range(0, moha_variable_get(MOHA_MAILER__VARIABLE__THRESHOLD, 20));
    $results = $query->execute();

    $ids = isset($results[__MOHA_MAILER_MAIL]) ? array_keys($results[__MOHA_MAILER_MAIL]) : array();
    $entities = $ids ? entity_load(__MOHA_MAILER_MAIL, $ids) : array();

    global $language;

    foreach ($entities as $entity) {
      $mail_to = $entity->mail_to;
      $mail_from = $entity->mail_from;

      $node = node_load($entity->nid);
      $params = array();
      $params['subject'] = $entity->subject;
      $content = node_view($node);
      $params['body'][] = drupal_render($content['body']);

      moha_throw_exception_per_variable(MOHA_MAILER__VARIABLE__SUSPEND);
      $message = drupal_mail(__MOHA_MAILER, 'moha_mailer_manual', $mail_to, $language, $params, $mail_from);

      if ($message['send'] === TRUE && $message['result'] === TRUE) {
        $entity->status = moha_array_key_by_value(MOHA__TERM__SUCCESS, MOHA__STATUS__ENTITY);
      }
      else {
        $entity->status = moha_array_key_by_value(MOHA__TERM__PROCESSED, MOHA__STATUS__ENTITY);
      }

      $entity->result = serialize($message);
      $entity->save();
    }
  }
  catch (Exception $e) {
    watchdog(__FUNCTION__, $e);
  }
}
